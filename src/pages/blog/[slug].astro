---
export const prerender = true;

import "@/styles/codeblock.css";
import "@/styles/blog.css";
import { type CollectionEntry, render } from "astro:content";
import BlogHero from "@components/blog/blog-hero.astro";
import TableOfContents from "@components/blog/table-of-contents.astro";
import SEO from "@components/seo.astro";
import Layout from "@layouts/layout.astro";
import { getPosts } from "@/utils/get-posts";

export async function getStaticPaths() {
   const posts = await getPosts();

   return posts.map((post) => ({
      params: { slug: post.id },
      props: post,
   }));
}

type Props = CollectionEntry<"blog">;
const post = Astro.props;
const { Content } = await render(post);
const canonicalUrl = post.data.canonicalUrl || `/blog/${post.id}`;
const postUrl = new URL(canonicalUrl, Astro.site).toString();
const breadcrumbs = [
   { name: "Home", url: new URL("/", Astro.site).toString() },
   { name: "Blog", url: new URL("/blog", Astro.site).toString() },
   { name: post.data.title, url: postUrl },
];
---

<Layout>
  <SEO
    slot="head"
    description={post.data.description}
    title={post.data.title}
    keywords={post.data.keywords}
    canonicalUrl={canonicalUrl}
    pubDate={post.data.pubDate.toISOString()}
    updatedDate={post.data.updatedDate?.toISOString()}
    ogImage={`/blog/${post.id}/og.png`}
    category={post.data.tags?.[0]}
    tags={post.data.tags}
    breadcrumbs={breadcrumbs}
  />

  <article class="flex flex-col gap-10 lg:gap-4">
    <BlogHero text={post.data.title} />
    <div class="relative mx-auto w-full max-w-full lg:max-w-[85ch]">
      <TableOfContents />
      <div
        class="animate-fade-in-up pb-14 text-base leading-7 text-pretty md:text-lg"
        data-blog-content
      >
        <Content />
      </div>
    </div>
  </article>

  <script>
    function initCopyButtons() {
      document
        .querySelectorAll("[data-rehype-pretty-code-figure]")
        .forEach((figure) => {
          if (figure.querySelector("[data-copy-btn]")) return;

          const code = figure.querySelector("code");
          if (!code) return;

          const lines = code.querySelectorAll("[data-line]");
          if (lines.length < 2) return;

          const btn = document.createElement("button");
          btn.setAttribute("data-copy-btn", "");
          btn.setAttribute("type", "button");
          btn.setAttribute("aria-label", "Kopiuj kod");
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;

          btn.addEventListener("click", async () => {
            const text = code.textContent || "";
            await navigator.clipboard.writeText(text);

            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
            setTimeout(() => {
              btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`;
            }, 2000);
          });

          figure.appendChild(btn);
        });
    }

    initCopyButtons();
    document.addEventListener("astro:after-swap", initCopyButtons);
  </script>
</Layout>
