---
export const prerender = true;

import { getCollection } from "astro:content";
import Layout from "@layouts/layout.astro";
import BlogContainer from "@/components/blog/blog-container.astro";
import BlogTags from "@/components/blog/blog-tags.astro";
import BlogList from "@/components/blog/blog-list.astro";
import { getPostsSorted } from "@/utils/get-posts-sorted";
import { getPosts } from "@/utils/get-posts";
import Seo from "@/components/seo.astro";

export async function getStaticPaths() {
  const posts = await getPosts();

  const tags = new Set<string>();

  posts.forEach((post) => {
    post.data.tags.forEach((tag) => tags.add(tag));
  });

  return Array.from(tags).map((tag) => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.params;

const posts = await getPostsSorted();
const allTags = new Set<string>();

posts.forEach((post) => {
  post.data.tags.forEach((tag) => allTags.add(tag));
});

const filteredPosts = posts.filter((post) => post.data.tags.includes(tag));

const seoData = {
  title: `#${tag}`,
  description: `Przeglądaj artykuły oznaczone tagiem "${tag}" na moim blogu.`,
  keywords: ["blog", "articles", "updates", "news", tag]
};
---

<Layout>
  <Seo
    slot="head"
    description={seoData.description}
    title={seoData.title}
    keywords={seoData.keywords}
  />
  <BlogContainer>
    <BlogTags selectedTag={tag} />
    <BlogList posts={filteredPosts} />
  </BlogContainer>
</Layout>
