---

---

<aside
  class="hidden xl:block absolute top-0 left-full ml-8 2xl:ml-14 mt-6 h-full w-[clamp(13rem,16vw,16rem)]"
  data-toc-aside
>
  <nav
    class="sticky top-32 max-h-[calc(100vh-9rem)] overflow-y-auto pr-1"
    data-toc-nav
    aria-label="Spis treÅ›ci"
  >
    <p
      class="text-foreground-secondary mb-3 text-xs font-semibold uppercase tracking-widest"
    >
      Na tej stronie
    </p>
    <ul
      class="border-accent/10 flex flex-col gap-1 border-l pl-2"
      data-toc-list
    >
    </ul>
  </nav>
</aside>

<script>
  type TocCleanup = () => void;

  declare global {
    interface Window {
      __tocCleanup?: TocCleanup;
    }
  }

  function initTableOfContents() {
    window.__tocCleanup?.();

    const tocList = document.querySelector(
      "[data-toc-list]",
    ) as HTMLUListElement | null;
    const tocAside = document.querySelector(
      "[data-toc-aside]",
    ) as HTMLElement | null;
    const content = document.querySelector(
      "[data-blog-content]",
    ) as HTMLElement | null;

    if (!tocList || !tocAside || !content) return;

    const headings = Array.from(
      content.querySelectorAll("h2[id], h3[id]"),
    ) as HTMLElement[];
    if (headings.length < 2) {
      tocAside.classList.add("!hidden");
      return;
    }

    tocAside.classList.remove("!hidden");
    tocList.innerHTML = "";

    const linksById = new Map<string, HTMLAnchorElement>();
    const clickHandlers: Array<{
      element: HTMLAnchorElement;
      handler: (event: MouseEvent) => void;
    }> = [];

    for (const heading of headings) {
      const id = heading.id;

      const clone = heading.cloneNode(true) as HTMLElement;
      clone.querySelectorAll("[data-anchor-hash]").forEach((el) => el.remove());
      const text = clone.textContent?.replace(/\s+/g, " ").trim() || "";

      if (!id || !text) continue;

      const li = document.createElement("li");
      const a = document.createElement("a");

      a.href = `#${id}`;
      a.textContent = text;
      a.title = text;
      a.setAttribute("data-toc-link", id);
      a.className = [
        "block truncate rounded-md px-2 py-1 text-xs leading-5 transition-all duration-300",
        "text-foreground-secondary hover:text-foreground",
        heading.tagName === "H3" ? "ml-4" : "",
      ]
        .filter(Boolean)
        .join(" ");

      const onClick = (event: MouseEvent) => {
        event.preventDefault();
        const target = document.getElementById(id);
        if (!target) return;
        target.scrollIntoView({ behavior: "smooth", block: "start" });
        history.replaceState(null, "", `#${id}`);
      };

      a.addEventListener("click", onClick);
      clickHandlers.push({ element: a, handler: onClick });
      linksById.set(id, a);

      li.appendChild(a);
      tocList.appendChild(li);
    }

    const headingOrder = headings.map((heading) => heading.id);
    const SCROLL_OFFSET = 130;
    let activeId = "";
    const visible = new Set<string>();

    const getClosestByScrollPosition = () => {
      let candidate = headingOrder[0] ?? "";
      for (const heading of headings) {
        if (heading.getBoundingClientRect().top <= SCROLL_OFFSET) {
          candidate = heading.id;
          continue;
        }
        break;
      }
      return candidate;
    };

    const getActiveFromVisible = () => {
      if (visible.size === 0) return getClosestByScrollPosition();

      let candidate = headingOrder[0] ?? "";
      for (const id of headingOrder) {
        if (visible.has(id)) candidate = id;
      }

      return candidate;
    };

    const updateActiveLink = (newActiveId: string) => {
      if (!newActiveId || newActiveId === activeId) return;

      activeId = newActiveId;
      for (const [id, link] of linksById) {
        const isActive = id === activeId;

        link.classList.toggle("text-accent", isActive);
        link.classList.toggle("bg-accent/10", isActive);
        link.classList.toggle("text-foreground-secondary", !isActive);
        link.classList.toggle("hover:text-foreground", !isActive);
        link.setAttribute("aria-current", isActive ? "location" : "false");

        if (isActive) {
          link.scrollIntoView({ block: "nearest" });
        }
      }
    };

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          const id = (entry.target as HTMLElement).id;
          if (!id) continue;

          if (entry.isIntersecting) {
            visible.add(id);
          } else {
            visible.delete(id);
          }
        }

        updateActiveLink(getActiveFromVisible());
      },
      {
        root: null,
        rootMargin: "-130px 0px -65% 0px",
        threshold: 0,
      },
    );

    for (const heading of headings) {
      observer.observe(heading);
    }

    const onScroll = () => {
      updateActiveLink(getClosestByScrollPosition());
    };

    updateActiveLink(
      window.location.hash?.slice(1) || getClosestByScrollPosition(),
    );
    window.addEventListener("scroll", onScroll, { passive: true });

    window.__tocCleanup = () => {
      observer.disconnect();
      window.removeEventListener("scroll", onScroll);

      for (const { element, handler } of clickHandlers) {
        element.removeEventListener("click", handler);
      }
    };
  }

  initTableOfContents();
  document.addEventListener("astro:after-swap", initTableOfContents);
</script>
